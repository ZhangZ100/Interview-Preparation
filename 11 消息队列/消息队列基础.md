### 为什么要用消息队列？

如果公司本身的业务体量很小，所以直接**单机一把梭**啥都能搞定了，但是后面业务体量不断扩大，采用**微服务的设计思想**，**分布式的部署方式**，所以拆分了很多的服务，随着体量的增加以及业务场景越来越复杂了，很多场景单机的技术栈和中间件以及不够用了，而且对系统的友好性也下降了，最后做了很多技术选型的工作，我们决定引入**消息队列中间件**。



### 消息队列使用场景

**异步、削峰、解耦**



- 异步：

![image-20220114145426227](%E6%B6%88%E6%81%AF%E9%98%9F%E5%88%97%E5%9F%BA%E7%A1%80.assets/image-20220114145426227.png)

链路长了就慢了，那你怎么解决的？

链路一长，整个流程的RT(Response Time)就变长，这一般是无法接受的。



![image-20220114145544050](%E6%B6%88%E6%81%AF%E9%98%9F%E5%88%97%E5%9F%BA%E7%A1%80.assets/image-20220114145544050.png)



**异步也可以用线程，线程池去做**



- 解耦

为啥我们不能用线程去做，因为用线程去做，需要写代码

一个订单流程，你扣积分，扣优惠券，发短信，扣库存......等等这么多业务要调用这么多的接口，**每次加一个你要调用一个接口然后还要重新发布系统**，写一次两次还好，写多了你就说：老子不干了！

而且真的全部都写在一起的话，不单单是耦合这一个问题，你出问题排查也麻烦，流程里面随便一个地方出问题搞不好会影响到其他的点，小伙伴说我每个流程都**try catch**不就行了，相信我别这么做，这样的代码就像个**定时炸弹💣**，你不知道什么时候爆炸，平时不炸偏偏在你做活动的时候炸，你就领个**P0故障**收拾书包**提前回家过年**吧。

Tip：P0—PN 是互联网大厂经常用来判定事故等级的机制，P0是最高等级了。

但是你用了**消息队列**，耦合这个问题就迎刃而解了呀。

![image-20220114145828582](%E6%B6%88%E6%81%AF%E9%98%9F%E5%88%97%E5%9F%BA%E7%A1%80.assets/image-20220114145828582.png)

![image-20220114145904374](%E6%B6%88%E6%81%AF%E9%98%9F%E5%88%97%E5%9F%BA%E7%A1%80.assets/image-20220114145904374.png)



- 削峰

![image-20220114150045699](%E6%B6%88%E6%81%AF%E9%98%9F%E5%88%97%E5%9F%BA%E7%A1%80.assets/image-20220114150045699.png)

![image-20220114150128116](%E6%B6%88%E6%81%AF%E9%98%9F%E5%88%97%E5%9F%BA%E7%A1%80.assets/image-20220114150128116.png)



### 消息队列的缺点

- 系统复杂性
- 数据一致性
- 可用性



- 系统复杂性

![image-20220114150511044](%E6%B6%88%E6%81%AF%E9%98%9F%E5%88%97%E5%9F%BA%E7%A1%80.assets/image-20220114150511044.png)

至于怎么解决这些问题，这些都是消息中间件的重点问题，不在此处介绍。



- 数据一致性

这个其实是分布式服务本身就存在的一个问题，**不仅仅是消息队列的问题**，但是放在这里说是因为用了消息队列这个问题会暴露得比较严重一点。

就像我开头说的，你下单的服务自己保证自己的逻辑成功处理了，你成功发了消息，但是优惠券系统，积分系统等等这么多系统，**他们成功还是失败你就不管了？**

![image-20220114150736491](%E6%B6%88%E6%81%AF%E9%98%9F%E5%88%97%E5%9F%BA%E7%A1%80.assets/image-20220114150736491.png)



- 可用性

你搞个系统本身没啥问题，你现在突然接入一个中间件在那放着，万一挂了怎么办？我下个单**MQ挂了**，优惠券不扣了，积分不减了，这不是杀一个程序员能搞定的吧，感觉得杀一片。

至于怎么保证高可用，还是那句话也不在这里展开讨论了，我后面一样会写，像写**Redis**那样写出来的。

总结：接入中间件后，如果中间件挂了，设计的很多业务环节都会出问题，所以可用性会出问题。



### 消息中间件的技术选型

![image-20220114151047671](%E6%B6%88%E6%81%AF%E9%98%9F%E5%88%97%E5%9F%BA%E7%A1%80.assets/image-20220114151047671.png)



![image-20220114151212999](%E6%B6%88%E6%81%AF%E9%98%9F%E5%88%97%E5%9F%BA%E7%A1%80.assets/image-20220114151212999.png)



![image-20220114151500099](%E6%B6%88%E6%81%AF%E9%98%9F%E5%88%97%E5%9F%BA%E7%A1%80.assets/image-20220114151500099.png)



### 重复消费、顺序消费、分布式事务































### 来源；链接

来自敖丙大佬

https://mp.weixin.qq.com/s/Qhw4oS0OeN1N7uT1z6rbqg